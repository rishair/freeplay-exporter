# Freeplay Exporter
The freeplay-exporter package is an OpenTelemetry exporter designed to send telemetry data from your applications to the Freeplay API. It is particularly useful for developers using Vercel's AI SDK, as it allows for seamless integration of telemetry data into Freeplay's observability platform. This package supports both Node.js and Next.js environments, making it versatile for various deployment scenarios, including short-lived environments like Vercel Cloud Functions.

## Installation
To install the freeplay-exporter package, run the following command in your terminal:

```sh
npm install freeplay-exporter
```

## Usage
To use the FreeplayExporter class, you need to create an instance with the appropriate configuration and integrate it with your OpenTelemetry setup. Below are examples for both Node.js and Next.js applications.

### Node.js Example
In a Node.js application, you can set up the exporter as follows:

```typescript
const { NodeTracerProvider } = require('@opentelemetry/sdk-trace-node'); 
const { SimpleSpanProcessor } = require('@opentelemetry/sdk-trace-base'); 
const { FreeplayExporter } = require('freeplay-exporter');

const provider = new NodeTracerProvider();
const exporter = new FreeplayExporter({
    baseUrl: 'https://app.freeplay.ai',
    projectId: 'your-project-id',
    apiKey: 'your-api-key',
    environment: 'production'
});
provider.addSpanProcessor(new SimpleSpanProcessor(exporter));
provider.register();

```

This sets up a basic tracer provider and attaches the FreeplayExporter to send telemetry data to the Freeplay API.

### Next.js Example
For Next.js applications, you can use the @vercel/otel package to simplify integration. Add the following to your instrumentation.ts file:

```typescript
import { registerOTel } from '@vercel/otel'; import { FreeplayExporter } from 'freeplay-exporter';

export function register() {
    const exporter = new FreeplayExporter({
        baseUrl: 'https://api.freeplay.ai',
        projectId: 'your-project-id',
        apiKey: 'your-api-key',
        environment: 'production'
    });
    registerOTel({
        serviceName: 'your-service-name',
        traceExporter: exporter,
    });
}
```

To enable the instrumentation hook, update your next.config.js:

```typescript
 module.exports = { instrumentationHook: true, // other configurations }; 
```
This ensures that telemetry is collected and exported in your Next.js application.

## Configuration
The FreeplayExporter class requires the following configuration options:

baseUrl: The base URL of the Freeplay API (e.g., 'https://api.freeplay.ai').
projectId: Your Freeplay project ID.
apiKey: Your Freeplay API key.
environment: The environment in which your application is running (e.g., 'production', 'staging').
These options ensure that telemetry data is sent to the correct Freeplay project and environment.

## Integration with Vercel AI SDK
When using Vercel's AI SDK, you can enable telemetry for specific function calls by setting the experimental_telemetry option. Hereâ€™s an example:

```typescript
import { generateText } from 'ai'; import { openai } from '@ai-sdk/openai';
const result = await generateText({
    model: openai('gpt-4-turbo'),
    prompt: 'Your prompt here',
    experimental_telemetry: {
        isEnabled: true,
        functionId: 'your-function-id', // Optional, for tracking specific functions
    },
});

```

The FreeplayExporter will automatically capture and send the telemetry data generated by these function calls to the Freeplay API.

## Support for Short-Lived Environments
The freeplay-exporter package is designed to work seamlessly in short-lived environments like Vercel Cloud Functions. It ensures that all telemetry data is exported before the function terminates, preventing data loss. This is achieved through the forceFlush method, which can be called to await the completion of all pending export operations.

For example, in a Next.js API route, you can use Vercel's waitUntil utility to flush the exporter:

```typescript
import { waitUntil } from '@vercel/functions'; import { exporter } from '../../instrumentation';

export default async function handler(req, res) {
    try {
        const result = await generateText({
            prompt: 'Hello, world!',
            experimental_telemetry: { isEnabled: true },
        });
        res.status(200).json({ success: true, result });
        waitUntil(exporter.forceFlush());
    } catch (error) {
        res.status(500).json({ error: error.message });
        waitUntil(exporter.forceFlush());
    }
}
```

This ensures that telemetry data is sent to Freeplay even after the response has been sent to the client.

## Contributing
If you'd like to contribute to the development of freeplay-exporter, please feel free to submit pull requests or open issues on the GitHub repository. We welcome contributions from the community!

## License
This package is released under the MIT License.
